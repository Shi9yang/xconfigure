656,657c656,657
< #if defined(__ELPA)
<      USE elpa1
---
> #if defined(__ELPA) || defined(__ELPA_2017) || defined(__ELPA_2016) || defined(__ELPA_2015)
>      use elpa1
679,680c680,681
<      INTEGER     :: i
< #if defined(__ELPA)
---
>      INTEGER     :: i, ierr
> #if defined(__ELPA) || defined(__ELPA_2017) || defined(__ELPA_2016) || defined(__ELPA_2015)     
681a683
>      LOGICAL     :: success
703c705
< #if defined(__ELPA)
---
> #if defined(__ELPA) || defined(__ELPA_2017) || defined(__ELPA_2016) || defined(__ELPA_2015)
704a707,717
> 
> #if defined(__ELPA_2017)
>      ierr = get_elpa_row_col_comms(ortho_comm, my_prow, my_pcol,mpi_comm_rows, mpi_comm_cols)
>      success = elpa_solve_evp_real_1stage_double(n, n, s, lds, w, vv, lds, SIZE(s,2), nb, mpi_comm_rows, mpi_comm_cols, ortho_comm)
> #elif defined(__ELPA_2016)
>      ierr = get_elpa_row_col_comms(ortho_comm, my_prow, my_pcol,mpi_comm_rows, mpi_comm_cols)
>      success = solve_evp_real_1stage(n,  n,   s, lds,    w,  vv, lds,SIZE(s,2),nb  ,mpi_comm_rows, mpi_comm_cols)
> #elif defined(__ELPA_2015)
>      ierr = get_elpa_row_col_comms(ortho_comm, my_prow, my_pcol,mpi_comm_rows, mpi_comm_cols)
>      ierr = solve_evp_real(n,  n,   s, lds,    w,  vv, lds,SIZE(s,2),nb  ,mpi_comm_rows, mpi_comm_cols)
> #elif defined(__ELPA)
707c720,721
<      
---
> #endif
> 
711,712c725,729
<      CALL mp_comm_free ( mpi_comm_rows )
<      CALL mp_comm_free ( mpi_comm_cols )
---
> #if defined __MPI
>      CALL mpi_comm_free( mpi_comm_rows, ierr )
>      CALL mpi_comm_free( mpi_comm_cols, ierr )
> #endif
> 
